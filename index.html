<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Room Creator + Dashboard</title>
<style>
:root{--bg:#0f1724;--accent:#4f46e5;--muted:#94a3b8}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:20px;background:linear-gradient(180deg,#071027 0%, #071429 100%);color:#e6eef8;position:relative}
.wrap{max-width:760px;margin:0 auto;position:relative}
h1{color:var(--accent);margin:0 0 12px 0}
label{display:block;margin-top:10px;color:var(--muted);font-size:13px}
input[type="text"], input[type="number"]{display:block;width:100%;max-width:360px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit;margin-top:6px;}
button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
.note{color:var(--muted);font-size:13px;margin-top:8px}
.top-right{position:absolute;top:20px;right:20px}
.dashboard-btn{background:#2563eb;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>Room Creator (Chat version)</h1>
  <p class="note">Pick a base folder. A <code>Rooms</code> subfolder will be created automatically.</p>

  <button id="selectFolderBtn">Select Save Folder</button>
  <button id="dashboardBtn" class="top-right dashboard-btn">Dashboard</button>
  <p id="selectedFolder" class="note"></p>

  <label for="owner">Owner Name</label>
  <input id="owner" type="text" placeholder="Your name" />

  <label for="room">Room Name (optional)</label>
  <input id="room" type="text" placeholder="Leave blank for auto name" />

  <label for="max">Max Viewers (0–1000)</label>
  <input id="max" type="number" min="0" max="1000" value="10" />

  <button id="createBtn">Create Room</button>
</div>

<script>
(async function(){
  const ownerEl = document.getElementById('owner');
  const roomEl  = document.getElementById('room');
  const maxEl   = document.getElementById('max');
  const btn     = document.getElementById('createBtn');
  const selectBtn = document.getElementById('selectFolderBtn');
  const selectedFolderLabel = document.getElementById('selectedFolder');
  const dashboardBtn = document.getElementById('dashboardBtn');

  let baseHandle = null;
  let roomsHandle = null;
  let counter = 0;

  function autoName(){ counter++; return `room-${counter}` }
  function sanitizeFilename(name){ return name.replace(/[\x00-\x1f\/\\?%*:|"<>]/g, '-').trim() || 'room'; }
  function clamp(n, min, max){ if(isNaN(n)) return min; return Math.min(max, Math.max(min, n)); }

  function buildRoomHtml({roomName, ownerName, maxViewers}){
    const esc = s => String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,"&#39;");
    return `<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${esc(roomName)}</title>
<style>
  :root{--bg:#0b1220;--accent:#4f46e5;--muted:#94a3b8}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6eef8}
  header{height:56px;background:#0f1724;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;padding:0 16px;gap:12px}
  .room-title{font-weight:700;font-size:18px}
  #leaveBtn{margin-left:auto;padding:6px 10px;border:none;border-radius:6px;background:#2563eb;color:white;cursor:pointer}
  .container{height:calc(100% - 56px);display:flex;flex-direction:column}
  .chat-area{flex:1;padding:16px;overflow:auto}
  .msg{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;margin:8px 0;max-width:75%}
  .input-row{display:flex;padding:12px;border-top:1px solid rgba(255,255,255,0.02);gap:8px;background:#0f1724}
  .input-row input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .input-row button{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
</style>
</head><body>
<header>
  <div class="room-title">${esc(roomName)}</div>
  <button id="leaveBtn">Leave</button>
</header>
<div class="container">
  <div id="chat" class="chat-area"></div>
  <div class="input-row">
    <input id="msg" placeholder="Type a message"/><button id="send">Send</button>
  </div>
</div>
<script>
  (function(){
    const chat=document.getElementById('chat');
    const msg=document.getElementById('msg');
    const send=document.getElementById('send');
    function append(t){const d=document.createElement('div');d.className='msg';d.textContent=t;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}
    send.onclick=()=>{const v=msg.value.trim();if(!v)return;append(v);msg.value='';msg.focus();};
    msg.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();send.click();}};
    append('Welcome to ${esc(roomName)}');
    document.getElementById('leaveBtn').onclick = () => { window.open('Rooms/dashboard.html','_blank'); window.close(); }
  })();
<\/script></body></html>`;
  }

  function buildDashboardHtml(){
    return `<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard</title>
<style>
  body{font-family:Inter,sans-serif;background:#0f1724;color:#e6eef8;padding:20px;}
  h1{color:#4f46e5}
  table{width:100%;border-collapse:collapse;margin-top:20px}
  th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left}
  th{color:#94a3b8}
  button{padding:6px 10px;border:none;border-radius:6px;background:#4f46e5;color:white;cursor:pointer}
</style>
</head>
<body>
<h1>Rooms Dashboard</h1>
<table>
  <thead>
    <tr><th>Room Name</th><th>Owner</th><th>Players</th><th>Max</th><th>Action</th></tr>
  </thead>
  <tbody id="roomsBody"></tbody>
</table>
<script>
(async function(){
  const tbody=document.getElementById('roomsBody');
  async function updateRooms(){
    try{
      const resp = await fetch('rooms.json');
      const rooms = await resp.json();
      tbody.innerHTML='';
      rooms.forEach(room=>{
        const tr = document.createElement('tr');
        tr.innerHTML = \`<td>\${room.name}</td><td>\${room.owner}</td><td>\${room.players}/\${room.max}</td><td>\${room.max}</td><td><button onclick="window.open('\${room.file}','_blank')">Join</button></td>\`;
        tbody.appendChild(tr);
      });
    }catch(e){
      tbody.innerHTML='<tr><td colspan="5">No rooms found. Create some rooms first.</td></tr>';
    }
  }
  await updateRooms();
  setInterval(updateRooms,5000);
})();
<\/script>
</body>
</html>`;
  }

  async function verifyPermission(handle, readWrite=false){
    const opts = readWrite ? { mode:'readwrite' } : {};
    if((await handle.queryPermission(opts)) === 'granted') return true;
    if((await handle.requestPermission(opts)) === 'granted') return true;
    return false;
  }

  async function saveRoomsManifest(){
    if(!roomsHandle) return;
    const manifestHandle = await roomsHandle.getFileHandle('rooms.json',{create:true});
    const writable = await manifestHandle.createWritable();
    const files = [];
    for await(const [name, handle] of roomsHandle.entries()){
      if(handle.kind==='file' && name.endsWith('.html') && name!=='dashboard.html'){
        const file = await handle.getFile();
        const text = await file.text();
        const ownerMatch = text.match(/<div class="room-title">(.+?)<\/div>/);
        const owner = ownerMatch ? ownerMatch[1]:'Unknown';
        const maxMatch = text.match(/Max Viewers.*?value="(\d+)"/);
        const max = maxMatch ? parseInt(maxMatch[1]):10;
        files.push({file:name,name:name.replace('.html',''),owner,players:1,max});
      }
    }
    await writable.write(JSON.stringify(files,null,2));
    await writable.close();
  }

  selectBtn.addEventListener('click', async () => {
    try {
      baseHandle = await window.showDirectoryPicker({mode:'readwrite'});
      if(!await verifyPermission(baseHandle,true)) throw new Error('Permission denied');
      roomsHandle = await baseHandle.getDirectoryHandle('Rooms',{create:true});
      selectedFolderLabel.textContent = `Folder selected: ${baseHandle.name}/Rooms`;

      // Create dashboard.html in Rooms folder
      const dashboardHandle = await roomsHandle.getFileHandle('dashboard.html',{create:true});
      const writable = await dashboardHandle.createWritable();
      await writable.write(buildDashboardHtml());
      await writable.close();
      await saveRoomsManifest();
    } catch(err){
      console.error('Folder selection error:',err);
    }
  });

  btn.addEventListener('click', async () => {
    if(!roomsHandle){ alert('Please select a save folder first.'); return; }
    const roomName = roomEl.value.trim() || autoName();
    const filename = sanitizeFilename(roomName) + '.html';
    const html = buildRoomHtml({ roomName, ownerName: ownerEl.value.trim(), maxViewers: clamp(parseInt(maxEl.value),1,1000) });
    try{
      const fileHandle = await roomsHandle.getFileHandle(filename,{create:true});
      const writable = await fileHandle.createWritable();
      await writable.write(html);
      await writable.close();
      roomEl.value='';
      await saveRoomsManifest();
    }catch(err){ console.error('Save error:',err); }
  });

  // ✅ Open real Rooms/dashboard.html, no blob
  dashboardBtn.addEventListener('click', () => {
    if(!roomsHandle){ alert('Please select a save folder first.'); return; }
    // Direct relative path
    window.open('Rooms/dashboard.html','_blank');
  });

})();
</script>
</body>
</html>
